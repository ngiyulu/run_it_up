<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Support Requests • RunItUp Admin</title>
    <link th:href="@{/styles.css}" rel="stylesheet" />
    <style>
        .filters { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
        .filters .field { display:flex; flex-direction:column; gap:6px; }
        .table td, .table th { white-space:nowrap; }
        .muted { color:#9ca3af; }
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <div class="brand">RunItUp • Admin</div>
        <nav class="nav">
            <a th:href="@{/admin/dashboard}">Dashboard</a>
            <a th:href="@{/admin/runs}">Run Sessions</a>
            <a th:href="@{/admin/gyms}">Gyms</a>
            <a th:href="@{/admin/support}">Support</a>
            <a href="#" id="logoutBtn">Logout</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;">Support Requests</h2>
    </div>

    <div id="status" class="alert hidden"></div>

    <div class="card" style="margin-bottom:12px;">
        <div class="filters">
            <div class="field">
                <label for="statusSel">Status</label>
                <select id="statusSel">
                    <option value="PENDING" selected>Pending</option>
                    <option value="RESOLVED">Resolved</option>
                </select>
            </div>

            <div class="field">
                <label for="onDate">Date (optional)</label>
                <input id="onDate" type="date" />
            </div>

            <div class="field" style="gap:8px;">
                <button class="primary" id="searchBtn" type="button">Search</button>
                <button class="secondary" id="resetBtn" type="button">Reset</button>
            </div>
        </div>
        <small class="help">Defaults to Pending across all dates. Add a date to filter to a specific day.</small>
    </div>

    <div class="card">
        <table class="table" id="supportTable">
            <thead>
            <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Resolved At</th>
            </tr>
            </thead>
            <tbody id="supportTbody">
            <tr><td colspan="5" class="muted" style="text-align:center;">Loading…</td></tr>
            </tbody>
        </table>
    </div>
</div>

<footer><div>© RunItUp Admin</div></footer>

<script th:src="@{/app.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        requireAuth();
        document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });

        const statusEl   = document.getElementById('status');
        const statusSel  = document.getElementById('statusSel');
        const onDateEl   = document.getElementById('onDate');
        const searchBtn  = document.getElementById('searchBtn');
        const resetBtn   = document.getElementById('resetBtn');
        const tbody      = document.getElementById('supportTbody');

        // Open native date picker on click/focus
        const openPicker = el => (typeof el.showPicker === 'function') ? el.showPicker() : (el.focus(), el.click());
        onDateEl.addEventListener('click', () => openPicker(onDateEl));
        onDateEl.addEventListener('focus', () => openPicker(onDateEl));

        // Initial load (Pending only, no date filter)
        await loadSupport();

        searchBtn.addEventListener('click', loadSupport);
        resetBtn.addEventListener('click', async () => {
            statusSel.value = 'PENDING';
            onDateEl.value = '';
            await loadSupport();
        });

        async function loadSupport() {
            try {
                setStatus(statusEl, 'success', 'Loading support requests…');

                let statusVal = statusSel.value || 'PENDING';
                if (statusVal === 'PROCESSED') statusVal = 'RESOLVED'; // defensive mapping

                const params = new URLSearchParams();
                params.set('status', statusVal);
                if (onDateEl.value) params.set('date', onDateEl.value); // expects backend to accept &date=YYYY-MM-DD

                const url = `/admin/api/v1/support/list?${params.toString()}`;
                const data = await api(url, { method: 'GET' });

                renderTable(Array.isArray(data) ? data : []);
                setStatus(statusEl, 'success', 'Loaded.');
            } catch (e) {
                console.error(e);
                setStatus(statusEl, 'error', 'Failed to load support requests.');
                tbody.innerHTML = `<tr><td colspan="5" class="muted" style="text-align:center;">No data.</td></tr>`;
            }
        }

        function renderTable(items) {
            if (!items.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="muted" style="text-align:center;">No support requests found.</td></tr>`;
                return;
            }
            const rows = items.map(s => {
                const email = s.email || '—';
                const name  = s.name  || '—';
                const status = s.status || 'PENDING';
                const createdAt  = prettyDate(s.createdAt);          // BaseModel.createdAt (LocalDate) or ISO string
                const resolvedAt = (status !== 'PENDING') ? prettyDate(s.resolvedAt) : '—';
                return `
          <tr>
            <td>${escapeHtml(email)}</td>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(status)}</td>
            <td>${createdAt}</td>
            <td>${resolvedAt}</td>
          </tr>
        `;
            }).join('');
            tbody.innerHTML = rows;
        }

        function prettyDate(val) {
            if (!val) return '—';
            if (/^\d{4}-\d{2}-\d{2}$/.test(String(val))) return String(val); // LocalDate
            const d = new Date(val);
            if (isNaN(d.getTime())) return String(val);
            return d.toLocaleDateString([], { year:'numeric', month:'short', day:'numeric' });
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => (
                { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[s]
            ));
        }
    });
</script>
</body>
</html>
