<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Support Requests • RunItUp Admin</title>
    <link th:href="@{/styles.css}" rel="stylesheet" />
    <style>
        .filters { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
        .filters .field { display:flex; flex-direction:column; gap:6px; }
        .table td, .table th { white-space:nowrap; }
        .muted { color:#9ca3af; }
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <div class="brand">RunItUp • Admin</div>
        <nav class="nav">
            <a th:href="@{/admin/dashboard}">Dashboard</a>
            <a th:href="@{/admin/runs}">Run Sessions</a>
            <a th:href="@{/admin/gyms}">Gyms</a>
            <a th:href="@{/admin/support}">Support</a>
            <a href="#" id="logoutBtn">Logout</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;">Support Requests</h2>
    </div>

    <div id="status" class="alert hidden"></div>

    <div class="card" style="margin-bottom:12px;">
        <div class="filters">
            <div class="field">
                <label for="statusSel">Status</label>
                <select id="statusSel">
                    <option value="PENDING" selected>Pending</option>
                    <option value="RESOLVED">Resolved</option>
                </select>
            </div>

            <div class="field">
                <label for="startDate">Start date</label>
                <input id="startDate" type="date" />
            </div>

            <div class="field">
                <label for="endDate">End date</label>
                <input id="endDate" type="date" />
            </div>

            <div class="field" style="gap:8px;">
                <button class="primary" id="searchBtn" type="button">Search</button>
                <button class="secondary" id="resetBtn" type="button">Reset</button>
            </div>
        </div>
        <small class="help">By default we show pending items. If you select <em>Resolved</em>, the “Resolved At” column will populate.</small>
    </div>

    <div class="card">
        <table class="table" id="supportTable">
            <thead>
            <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Status</th>
                <th>Resolved At</th>
            </tr>
            </thead>
            <tbody id="supportTbody">
            <tr><td colspan="4" class="muted" style="text-align:center;">Loading…</td></tr>
            </tbody>
        </table>
    </div>
</div>

<footer><div>© RunItUp Admin</div></footer>

<script th:src="@{/app.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        requireAuth();
        document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });

        const statusEl   = document.getElementById('status');
        const statusSel  = document.getElementById('statusSel');
        const startDateEl= document.getElementById('startDate');
        const endDateEl  = document.getElementById('endDate');
        const searchBtn  = document.getElementById('searchBtn');
        const resetBtn   = document.getElementById('resetBtn');
        const tbody      = document.getElementById('supportTbody');

        // Open native date pickers on click/focus (with fallback)
        [startDateEl, endDateEl].forEach(el => {
            const open = () => (typeof el.showPicker === 'function') ? el.showPicker() : (el.focus(), el.click());
            el.addEventListener('click', open);
            el.addEventListener('focus', open);
        });

        // Initial load: Pending only
        await loadSupport();

        // Search click with validation
        searchBtn.addEventListener('click', async () => {
            const start = startDateEl.value;
            const end   = endDateEl.value;

            // Validate: end cannot be before start
            if (start && end) {
                const sd = new Date(start), ed = new Date(end);
                if (ed < sd) {
                    setStatus(statusEl, 'error', 'End date cannot be earlier than start date.');
                    return;
                }
            }
            await loadSupport();
        });

        // Reset clears dates and returns to pending
        resetBtn.addEventListener('click', async () => {
            statusSel.value = 'PENDING';
            startDateEl.value = '';
            endDateEl.value = '';
            await loadSupport();
        });

        async function loadSupport() {
            try {
                setStatus(statusEl, 'success', 'Loading support requests…');

                // Build query
                let statusVal = statusSel.value;
                // Defensive mapping if backend still accepts "PROCESSED"
                if (statusVal === 'PROCESSED') statusVal = 'RESOLVED';

                const params = new URLSearchParams();
                params.set('status', statusVal || 'PENDING');
                if (startDateEl.value) params.set('start', startDateEl.value);
                if (endDateEl.value)   params.set('end',   endDateEl.value);

                const url = `/admin/api/v1/support/list?${params.toString()}`;
                const data = await api(url, { method: 'GET' });

                renderTable(Array.isArray(data) ? data : []);
                setStatus(statusEl, 'success', 'Loaded.');
            } catch (e) {
                console.error(e);
                setStatus(statusEl, 'error', 'Failed to load support requests.');
                tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center;">No data.</td></tr>`;
            }
        }

        function renderTable(items) {
            if (!items.length) {
                tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center;">No support requests found.</td></tr>`;
                return;
            }

            const rows = items.map(s => {
                const email = s.email || '—';
                const name  = s.name  || '—';
                const status = s.status || 'PENDING';
                const resolvedAt = (status !== 'PENDING') ? prettyDate(s.resolvedAt) : '—';
                return `
          <tr>
            <td>${escapeHtml(email)}</td>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(status)}</td>
            <td>${resolvedAt}</td>
          </tr>
        `;
            }).join('');
            tbody.innerHTML = rows;
        }

        function prettyDate(val) {
            if (!val) return '—';
            if (/^\d{4}-\d{2}-\d{2}$/.test(String(val))) return String(val);
            const d = new Date(val);
            if (isNaN(d.getTime())) return String(val);
            return d.toLocaleDateString([], { year:'numeric', month:'short', day:'numeric' });
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => (
                { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[s]
            ));
        }
    });
</script>
</body>
</html>
