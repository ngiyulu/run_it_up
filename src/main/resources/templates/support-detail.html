<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Support Detail • RunItUp Admin</title>
    <link th:href="@{/styles.css}" rel="stylesheet" />
    <style>
        .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px 16px; }
        .kv .k { color:#9ca3af; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .desc { white-space: pre-wrap; line-height: 1.5; }
        .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .muted { color:#9ca3af; }
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <div class="brand">RunItUp • Admin</div>
        <nav class="nav">
            <a th:href="@{/admin/dashboard}">Dashboard</a>
            <a th:href="@{/admin/runs}">Run Sessions</a>
            <a th:href="@{/admin/gyms}">Gyms</a>
            <a th:href="@{/admin/support}">Support</a>
            <a href="#" id="logoutBtn">Logout</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2 id="pageTitle" style="margin:0;">Support Ticket</h2>
        <div class="actions">
            <button id="resolveBtn" class="primary">Resolve</button>
        </div>
    </div>

    <div id="status" class="alert hidden"></div>

    <div class="card" id="detailCard" style="margin-bottom:12px;">
        <div class="kv">
            <div class="k">Ticket ID</div><div id="ticketId" class="mono">—</div>
            <div class="k">Name</div><div id="name">—</div>
            <div class="k">Email</div><div id="email">—</div>
            <div class="k">Status</div><div id="statusVal">—</div>
            <div class="k">Created At</div><div id="createdAt">—</div>
            <div class="k">Resolved At</div><div id="resolvedAt">—</div>
            <div class="k">Processed By</div><div id="processedBy">—</div>
        </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
        <h3 style="margin-top:0;">Description</h3>
        <div id="description" class="desc">—</div>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Notes</h3>
        <textarea id="notes" rows="6" placeholder="Add notes before resolving…" style="width:100%;"></textarea>
        <small class="help">Notes are required to resolve.</small>
    </div>
</div>

<footer><div>© RunItUp Admin</div></footer>

<script th:src="@{/app.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        requireAuth();
        document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });

        const statusEl   = document.getElementById('status');
        const resolveBtn = document.getElementById('resolveBtn');

        const params   = new URLSearchParams(location.search);
        const ticketId = params.get('id');
        if (!ticketId) {
            setStatus(statusEl, 'error', 'Missing support ticket id.');
            return;
        }

        // DOM refs
        const pageTitle  = document.getElementById('pageTitle');
        const ticketIdEl = document.getElementById('ticketId');
        const nameEl     = document.getElementById('name');
        const emailEl    = document.getElementById('email');
        const statusVal  = document.getElementById('statusVal');
        const createdAt  = document.getElementById('createdAt');
        const resolvedAt = document.getElementById('resolvedAt');
        const processedBy= document.getElementById('processedBy');
        const descEl     = document.getElementById('description');
        const notesEl    = document.getElementById('notes');

        let model = null;

        try {
            setStatus(statusEl, 'success', 'Loading support ticket…');
            model = await api(`/admin/api/v1/support/${encodeURIComponent(ticketId)}`, { method:'GET' });
            render(model);
            setStatus(statusEl, 'success', 'Loaded.');
        } catch (e) {
            console.error(e);
            setStatus(statusEl, 'error', 'Failed to load support ticket.');
            // On load failure, disable resolve & notes
            resolveBtn.disabled = true;
            notesEl.disabled = true;
            return;
        }

        // Resolve click
        resolveBtn.addEventListener('click', async () => {
            if (!model) return;
            const currentStatus = normalizeStatus(model.status);
            if (currentStatus !== 'PENDING') return;

            const notes = (notesEl.value || '').trim();
            if (!notes) {
                setStatus(statusEl, 'error', 'Please enter notes before resolving.');
                notesEl.focus();
                return;
            }

            try {
                resolveBtn.disabled = true;
                notesEl.disabled = true;
                setStatus(statusEl, 'success', 'Resolving…');

                const payload = {
                    supportTicketId: model.id || ticketId,
                    notes
                };
                const updated = await api('/admin/api/v1/support/resolve', {
                    method: 'POST',
                    data: payload
                });

                // Re-render with updated ticket (prefer response; if none, re-fetch)
                model = updated || await api(`/admin/api/v1/support/${encodeURIComponent(ticketId)}`, { method:'GET' });
                render(model);
                setStatus(statusEl, 'success', 'Ticket resolved.');
            } catch (e) {
                console.error(e);
                setStatus(statusEl, 'error', e.message || 'Failed to resolve ticket.');
                resolveBtn.disabled = false;
                notesEl.disabled = false;
            }
        });

        /* --------- helpers --------- */
        function render(s) {
            const st = normalizeStatus(s.status);

            const titleName = s.name || s.requesterName || 'Support Ticket';
            pageTitle.textContent = `Support • ${titleName}`;

            ticketIdEl.textContent = s.id || ticketId;
            nameEl.textContent     = titleName;
            emailEl.textContent    = s.email || s.requesterEmail || '—';
            statusVal.textContent  = st;

            createdAt.textContent  = prettyDateTime(s.createdAt);
            resolvedAt.textContent = st !== 'PENDING' ? prettyDate(s.resolvedAt) : '—';

            const processed =
                (s.admin && (s.admin.first ? `${s.admin.first} ${s.admin.last || ''}`.trim() : (s.admin.email || s.admin.id))) ||
                s.resolvedBy || '—';
            processedBy.textContent = st !== 'PENDING' ? processed : '—';

            descEl.textContent = s.description || '—';

            // Notes: show existing notes, lock when not pending
            notesEl.value    = (s.notes || '').trim();
            const isPending  = (st === 'PENDING');
            notesEl.disabled = !isPending;
            resolveBtn.style.display = isPending ? '' : 'none';
        }

        function normalizeStatus(v) {
            const x = String(v || '').toUpperCase();
            if (x === 'PROCESSED') return 'RESOLVED';
            return x || 'PENDING';
        }

        function prettyDate(val) {
            if (!val) return '—';
            // Accept LocalDate 'YYYY-MM-DD' or ISO string
            if (/^\d{4}-\d{2}-\d{2}$/.test(String(val))) return String(val);
            const d = new Date(val);
            if (isNaN(d.getTime())) return String(val);
            return d.toLocaleDateString([], { year:'numeric', month:'short', day:'numeric' });
        }

        function prettyDateTime(val) {
            if (!val) return '—';
            const d = new Date(val);
            if (isNaN(d.getTime())) return String(val);
            return d.toLocaleString([], { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
        }
    });
</script>
</body>
</html>
