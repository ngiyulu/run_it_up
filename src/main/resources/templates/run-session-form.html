<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Run Session • RunItUp Admin</title>
    <link th:href="@{/styles.css}" rel="stylesheet" />
    <style>
        .tabs { display:flex; gap:12px; border-bottom:1px solid #1f2937; margin-bottom:12px; }
        .tab { padding:8px 12px; border:1px solid #1f2937; border-bottom:none; border-radius:10px 10px 0 0; cursor:pointer; }
        .tab.active { background:#0b1220; font-weight:600; }
        .tabpanel { display:none; }
        .tabpanel.active { display:block; }
        .muted { opacity:0.5; pointer-events:none; }
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
        .modal { background:#0b1220; border:1px solid #1f2937; border-radius:14px; padding:16px; width:min(900px, 95vw); max-height:85vh; overflow:auto; }
        .show { display:flex !important; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        .gym-item { display:flex; gap:10px; align-items:center; border:1px solid #1f2937; border-radius:10px; padding:8px; }
        .gym-item img { width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #1f2937;}
        .list { display:grid; gap:8px; }
        .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #1f2937; }
        .rowline { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #1f2937; border-radius:10px; }
        .hidden { display:none !important; }
        .danger { background:#7f1d1d; border-color:#7f1d1d; }
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <div class="brand">RunItUp • Admin</div>
        <nav class="nav">
            <a th:href="@{/admin/dashboard}">Dashboard</a>
            <a th:href="@{/admin/runsessions}">Run Sessions</a>
            <a th:href="@{/admin/gyms}">Gyms</a>
            <a href="#" id="logoutBtn">Logout</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="toolbar">
        <h2 id="pageTitle">Create Run Session</h2>
        <div class="badge">JWT auth required</div>
    </div>

    <div id="status" class="alert hidden"></div>

    <div class="tabs">
        <div class="tab active" data-tab="details">Details</div>
        <div class="tab" data-tab="players">Players</div>
        <div class="tab" data-tab="waitlist">Waitlist</div>
    </div>

    <form id="runForm" class="card tabpanel active" data-panel="details" style="max-width:1000px;">
        <div class="row">
            <div class="col">
                <label for="title">Title *</label>
                <input id="title" placeholder="Morning Run at Downtown Gym" required />
            </div>
            <div class="col">
                <label for="date">Date *</label>
                <input id="date" type="date" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="startTime">Start Time *</label>
                <input id="startTime" type="time" required />
            </div>
            <div class="col">
                <label for="endTime">End Time *</label>
                <input id="endTime" type="time" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="amount">Amount per player *</label>
                <input id="amount" type="number" step="0.01" min="0" placeholder="15.00" required />
            </div>
            <div class="col">
                <label for="maxPlayer">Max Players *</label>
                <input id="maxPlayer" type="number" min="10" placeholder="20" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label class="checkbox">
                    <input id="allowGuest" type="checkbox" />
                    Allow Guests
                </label>
            </div>
            <div class="col">
                <label for="maxGuest">Max Guests</label>
                <input id="maxGuest" type="number" min="0" placeholder="0" />
                <small class="help" id="guestHelp">Disabled when "Allow Guests" is off.</small>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label class="checkbox">
                    <input id="privateRun" type="checkbox" />
                    Private run (unlisted)
                </label>
            </div>
            <div class="col">
                <label for="hostedBy">Hosted By *</label>
                <input id="hostedBy" placeholder="Coach / Organizer" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="notes">Notes</label>
                <textarea id="notes" rows="3" placeholder="Internal notes..."></textarea>
            </div>
            <div class="col">
                <label for="description">Description</label>
                <textarea id="description" rows="3" placeholder="Public description shown to players..."></textarea>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Gym *</label>
                <div class="row" style="gap:10px; align-items:center;">
                    <input id="gymTitle" placeholder="Select a gym..." readonly required />
                    <button type="button" class="primary" id="chooseGymBtn">Choose Gym</button>
                </div>
                <small id="gymAddress" class="help">No gym selected.</small>
                <input type="hidden" id="gymId" />
            </div>
            <div class="col">
                <label for="zoneId">Time Zone (IANA) *</label>
                <input id="zoneId" placeholder="America/Chicago" required />
            </div>
        </div>

        <div class="row" style="align-items:flex-start;">
            <div class="col" style="display:flex; gap:10px; align-items:center;">
                <button class="primary" id="saveBtn" type="submit">Save</button>
                <button id="resetBtn" type="button">Reset</button>
                <button id="cancelBtn" type="button" class="danger">Cancel</button>
            </div>
        </div>
    </form>

    <div class="card tabpanel" data-panel="players">
        <div class="toolbar"><h3>Players</h3></div>
        <div id="playersList" class="list">
            <div class="rowline" style="justify-content:center; color:gray;">No data.</div>
        </div>
    </div>

    <div class="card tabpanel" data-panel="waitlist">
        <div class="toolbar"><h3>Waitlist</h3></div>
        <div id="waitList" class="list">
            <div class="rowline" style="justify-content:center; color:gray;">No data.</div>
        </div>
    </div>
</div>

<footer><div>© RunItUp Admin</div></footer>

<!-- Gym Picker Modal -->
<div id="gymModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Choose Gym">
        <div class="toolbar">
            <h3>Choose Gym</h3>
            <div style="display:flex; gap:8px; margin-left:auto;">
                <input id="gymSearch" type="search" placeholder="Search gyms…" />
                <button id="gymCloseBtn" type="button">Close</button>
            </div>
        </div>
        <div id="gymList" class="grid"></div>
        <div id="gymEmpty" class="alert hidden">No gyms found.</div>
    </div>
</div>

<script th:src="@{/app.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        requireAuth();
        const $ = (q) => document.querySelector(q);
        const statusEl = $('#status');
        const dateEl = $('#date');
        const startEl = $('#startTime');
        const endEl = $('#endTime');
        const maxPlayerEl = $('#maxPlayer');
        const maxGuestEl = $('#maxGuest');
        const allowGuestEl = $('#allowGuest');
        const guestHelp = $('#guestHelp');

        // --- Open pickers when clicked/focused ---
        function openPicker(el) {
            if (typeof el.showPicker === 'function') el.showPicker();
            else { el.focus(); el.click(); }
        }
        [dateEl, startEl, endEl].forEach(el => {
            el.addEventListener('click', () => openPicker(el));
            el.addEventListener('focus', () => openPicker(el));
        });

        // --- Enforce Max Players >= 10 & Max Guests ≤ Max Players ---
        function syncMaxGuestCap() {
            const maxPlayers = parseInt(maxPlayerEl.value || '0', 10);
            maxGuestEl.max = Math.max(0, maxPlayers);
            const mg = parseInt(maxGuestEl.value || '0', 10);
            if (!Number.isNaN(mg) && mg > maxPlayers) maxGuestEl.value = String(maxPlayers);
        }

        maxPlayerEl.addEventListener('input', () => {
            const val = parseInt(maxPlayerEl.value || '0', 10);
            if (!Number.isNaN(val) && val < 10) maxPlayerEl.value = '10';
            syncMaxGuestCap();
        });

        allowGuestEl.addEventListener('change', () => {
            syncGuest();
            syncMaxGuestCap();
        });

        function syncGuest() {
            const enabled = allowGuestEl.checked;
            maxGuestEl.disabled = !enabled;
            guestHelp.classList.toggle('hidden', enabled);
            maxGuestEl.classList.toggle('muted', !enabled);
            if (!enabled) maxGuestEl.value = '';
        }
        syncGuest();
        syncMaxGuestCap();
    });
</script>
</body>
</html>