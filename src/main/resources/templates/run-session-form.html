<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Run Session • RunItUp Admin</title>
    <link th:href="@{/styles.css}" rel="stylesheet" />
    <style>
        .tabs { display:flex; gap:12px; border-bottom:1px solid #1f2937; margin-bottom:12px; }
        .tab { padding:8px 12px; border:1px solid #1f2937; border-bottom:none; border-radius:10px 10px 0 0; cursor:pointer; }
        .tab.active { background:#0b1220; font-weight:600; }
        .tabpanel { display:none; }
        .tabpanel.active { display:block; }
        .muted { opacity:0.5; pointer-events:none; }
        .hidden { display:none !important; }
        .danger { background:#7f1d1d; border-color:#7f1d1d; }

        /* Gym modal styles */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
        .modal { background:#0b1220; border:1px solid #1f2937; border-radius:14px; padding:16px; width:min(900px,95vw); max-height:85vh; overflow:auto; }
        .modal .toolbar { display:flex; align-items:center; gap:8px; margin:0 0 10px 0; }
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

        .gym-card { display:flex; gap:12px; align-items:center; border:1px solid #1f2937; border-radius:12px; padding:10px; }
        .gym-thumb { width:72px; height:72px; object-fit:cover; border-radius:10px; border:1px solid #1f2937; background:#0f172a; }
        .gym-body { flex:1; min-width:0; }
        .gym-title { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .gym-address { color:#9ca3af; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <div class="brand">RunItUp • Admin</div>
        <nav class="nav">
            <a th:href="@{/admin/dashboard}">Dashboard</a>
            <a th:href="@{/admin/runsessions}">Run Sessions</a>
            <a th:href="@{/admin/gyms}">Gyms</a>
            <a href="#" id="logoutBtn">Logout</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="toolbar">
        <h2 id="pageTitle">Create Run Session</h2>
    </div>

    <div id="status" class="alert hidden"></div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="details">Details</div>
        <div class="tab" data-tab="players">Players</div>
        <div class="tab" data-tab="waitlist">Waitlist</div>
    </div>

    <!-- Details -->
    <form id="runForm" class="card tabpanel active" data-panel="details" style="max-width:1000px;">
        <div class="row">
            <div class="col">
                <label for="title">Title *</label>
                <input id="title" placeholder="Morning Run at Downtown Gym" required />
            </div>
            <div class="col">
                <label for="date">Date *</label>
                <input id="date" type="date" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="startTime">Start Time *</label>
                <input id="startTime" type="time" required />
            </div>
            <div class="col">
                <label for="endTime">End Time *</label>
                <input id="endTime" type="time" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="amount">Amount per player *</label>
                <input id="amount" type="number" step="0.01" min="0" placeholder="15.00" required />
            </div>
            <div class="col">
                <label for="maxPlayer">Max Players *</label>
                <input id="maxPlayer" type="number" min="10" placeholder="20" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label class="checkbox"><input id="allowGuest" type="checkbox" /> Allow Guests</label>
            </div>
            <div class="col">
                <label for="maxGuest">Max Guests</label>
                <input id="maxGuest" type="number" min="0" placeholder="0" />
                <small class="help" id="guestHelp">Disabled when "Allow Guests" is off.</small>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label class="checkbox"><input id="privateRun" type="checkbox" /> Private run (unlisted)</label>
            </div>
            <div class="col">
                <label for="hostedBy">Hosted By *</label>
                <input id="hostedBy" placeholder="Coach / Organizer" required />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="notes">Notes</label>
                <textarea id="notes" rows="3" placeholder="Internal notes..."></textarea>
            </div>
            <div class="col">
                <label for="description">Description</label>
                <textarea id="description" rows="3" placeholder="Public description shown to players..."></textarea>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Gym *</label>
                <div class="row" style="gap:10px; align-items:center;">
                    <input id="gymTitle" placeholder="Select a gym..." readonly required />
                    <button type="button" class="primary" id="chooseGymBtn">Choose Gym</button>
                </div>
                <small id="gymAddress" class="help">No gym selected.</small>
                <input type="hidden" id="gymId" />
            </div>
            <div class="col">
                <label for="zoneId">Time Zone *</label>
                <input id="zoneId" placeholder="America/Chicago" required />
            </div>
        </div>

        <div class="row" style="align-items:flex-start;">
            <div class="col" style="display:flex; gap:10px; align-items:center;">
                <button class="primary" id="saveBtn" type="submit">Save</button>
                <button id="resetBtn" type="button">Reset</button>
                <button id="cancelBtn" type="button" class="danger">Cancel</button>
            </div>
        </div>
    </form>

    <!-- Players -->
    <div class="card tabpanel" data-panel="players">
        <div class="toolbar"><h3>Players</h3></div>
        <div id="playersList" class="list"><div class="rowline" style="justify-content:center;color:gray;">No data.</div></div>
    </div>

    <!-- Waitlist -->
    <div class="card tabpanel" data-panel="waitlist">
        <div class="toolbar"><h3>Waitlist</h3></div>
        <div id="waitList" class="list"><div class="rowline" style="justify-content:center;color:gray;">No data.</div></div>
    </div>
</div>

<footer><div>© RunItUp Admin</div></footer>

<!-- ✅ Gym Picker Modal -->
<div id="gymModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Choose Gym">
        <div class="toolbar">
            <h3 style="margin:0;">Choose Gym</h3>
            <input id="gymSearch" type="search" placeholder="Search gyms…" style="margin-left:auto;" />
            <button id="gymCloseBtn" type="button">Close</button>
        </div>
        <div id="gymList" class="grid"></div>
        <div id="gymEmpty" class="alert hidden" style="margin-top:10px;">No gyms found.</div>
    </div>
</div>

<script th:src="@{/app.js}"></script>
<script>
    // --- Address helper
    function formatGymAddress(g) {
        return [g.line1, g.line2, g.city, g.state, g.zip].filter(Boolean).join(', ') || 'No address';
    }

    // --- Gym Modal Renderer
    function renderGyms(gyms) {
        const gymList = document.getElementById('gymList');
        const gymEmpty = document.getElementById('gymEmpty');
        const gymIdEl = document.getElementById('gymId');
        const gymTitleEl = document.getElementById('gymTitle');
        const gymAddrEl = document.getElementById('gymAddress');

        gymList.innerHTML = '';
        if (!gyms || gyms.length === 0) {
            gymEmpty.classList.remove('hidden');
            return;
        }
        gymEmpty.classList.add('hidden');

        gyms.sort((a,b) => (a.title).localeCompare(b.title , undefined, {sensitivity:'base'}));

        gyms.forEach(g => {
            const card = document.createElement('div');
            card.className = 'gym-card';

            const imgUrl = g.image
            const title = g.title
            const address = formatGymAddress(g);
            console.log(address)
            console.log(title)
            const img = document.createElement('img');
            img.className = 'gym-thumb';
            img.alt = title;
            if (imgUrl) img.src = imgUrl; else img.style.display = 'none';

            const body = document.createElement('div');
            body.className = 'gym-body';
            body.innerHTML = `<div class="gym-title">${title}</div><div class="gym-address">${address}</div>`;

            const btn = document.createElement('button');
            btn.className = 'primary';
            btn.textContent = 'Select';
            btn.onclick = () => {
                gymIdEl.value = g.id;
                gymTitleEl.value = title;
                gymAddrEl.textContent = address;
                closeGymPicker();
            };

            card.appendChild(img);
            card.appendChild(body);
            card.appendChild(btn);
            gymList.appendChild(card);
        });
    }

    function closeGymPicker() {
        const modal = document.getElementById('gymModal');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
    }

    function openGymPicker() {
        const modal = document.getElementById('gymModal');
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
        loadGyms();
    }

    async function loadGyms() {
        try {
            let gyms = await api('/admin/api/v1/gym/list');
            const search = document.getElementById('gymSearch').value.trim().toLowerCase();
            if (search) gyms = gyms.filter(g => (g.title || '').toLowerCase().includes(search));
            renderGyms(gyms);
        } catch (e) {
            console.error(e);
            renderGyms([]);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('chooseGymBtn').onclick = openGymPicker;
        document.getElementById('gymCloseBtn').onclick = closeGymPicker;
        document.getElementById('gymSearch').oninput = () => loadGyms();
    });
</script>
</body>
</html>
