<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User • RunItUp Admin</title>
    <link th:href="@{/styles.css}" rel="stylesheet" />
    <style>
        .user-card { display:flex; gap:16px; align-items:flex-start; }
        .user-avatar {
            width:120px; height:120px; border-radius:12px; object-fit:cover;
            border:1px solid #1f2937; background:#0f172a;
        }
        .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; }
        .kv .k { color:#9ca3af; }
        .row-inline { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .badge.success { background:#065f46; border-color:#065f46; }
        .link { text-decoration: underline; }
        .muted { color:#9ca3af; }
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <div class="brand">RunItUp • Admin</div>
        <nav class="nav">
            <a th:href="@{/admin/dashboard}">Dashboard</a>
            <a th:href="@{/admin/runs}">Run Sessions</a>
            <a th:href="@{/admin/gyms}">Gyms</a>
            <a href="#" id="logoutBtn">Logout</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="toolbar">
        <h2 id="title">User</h2>
    </div>

    <div id="status" class="alert hidden"></div>

    <div class="card user-card" id="userCard">
        <img id="avatar" class="user-avatar" alt="User" />
        <div style="flex:1 1 auto; min-width:0;">
            <div class="row-inline">
                <h3 id="fullName" style="margin:0;">—</h3>
                <span id="levelBadge" class="badge hidden"></span>
                <span id="enabledBadge" class="badge hidden"></span>
            </div>

            <div class="kv" style="margin-top:12px;">
                <div class="k">User ID</div><div id="uid">—</div>
                <div class="k">Email</div><div id="email">—</div>

                <div class="k">Phone</div>
                <div class="row-inline">
                    <span id="phone">—</span>
                    <span id="phoneVerified" class="badge success hidden">Verified</span>
                </div>

                <div class="k">Date of Birth</div><div id="dob">—</div>
                <div class="k">Skill</div><div id="skill">—</div>
                <div class="k">Joined</div><div id="joined">—</div>

                <!-- Waiver block -->
                <div class="k">Waiver</div>
                <div id="waiverBlock">
                    <div id="waiverLinkRow" class="row-inline hidden">
                        <a id="waiverLink" class="link" href="#" target="_blank" rel="noopener">View waiver</a>
                    </div>
                    <div id="waiverSignedRow" class="hidden">
                        <span class="muted">Signed:</span> <span id="waiverSignedAt">—</span>
                    </div>
                    <div id="waiverNotesRow" class="hidden">
                        <span class="muted">Notes:</span> <span id="waiverNotes">—</span>
                    </div>
                    <div id="waiverEmpty" class="muted">No waiver on file.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer><div>© RunItUp Admin</div></footer>

<script th:src="@{/app.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        requireAuth();
        document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });

        const statusEl = document.getElementById('status');
        const params = new URLSearchParams(location.search);
        const userId = params.get('id');

        if (!userId) {
            setStatus(statusEl, 'error', 'Missing user id.');
            return;
        }

        try {
            setStatus(statusEl, 'success', 'Loading user…');
            const u = await api(`/admin/api/v1/user/retrieve/${encodeURIComponent(userId)}`, { method:'GET' });

            // DOM refs
            const avatar = document.getElementById('avatar');
            const fullName = document.getElementById('fullName');
            const title = document.getElementById('title');
            const uid = document.getElementById('uid');
            const email = document.getElementById('email');
            const phone = document.getElementById('phone');
            const phoneVerified = document.getElementById('phoneVerified');
            const dob = document.getElementById('dob');
            const skill = document.getElementById('skill');
            const joined = document.getElementById('joined');
            const levelBadge = document.getElementById('levelBadge');
            const enabledBadge = document.getElementById('enabledBadge');

            const waiverEmpty = document.getElementById('waiverEmpty');
            const waiverLinkRow = document.getElementById('waiverLinkRow');
            const waiverLink = document.getElementById('waiverLink');
            const waiverSignedRow = document.getElementById('waiverSignedRow');
            const waiverSignedAt = document.getElementById('waiverSignedAt');
            const waiverNotesRow = document.getElementById('waiverNotesRow');
            const waiverNotes = document.getElementById('waiverNotes');

            // Render core fields
            avatar.src = u.imageUrl || u.photoUrl || '';
            avatar.onerror = () => { avatar.style.display = 'none'; };

            const name = [u.first, u.last].filter(Boolean).join(' ') || u.name || '—';
            fullName.textContent = name;
            title.textContent = `User • ${name}`;

            uid.textContent = u.id || u.userId || userId;
            email.textContent = u.email || '—';

            // Phone + verified indicator
            const phoneVal =u.phoneNumber  || '—';
            phone.textContent = phoneVal;
            const isVerified = u.verifiedPhone;
            phoneVerified.classList.toggle('hidden', !isVerified);

            // DOB (accepts ISO date or YYYY-MM-DD)
            dob.textContent = prettyDate(u.dob);

            // Skill
            skill.textContent = u.skillLevel || '—';

            // Joined
            joined.textContent = prettyDateTime(u.createdAt);

            // Level / Enabled badges
            if (u.skillLevel) {
                levelBadge.textContent = String(u.skillLevel);
                levelBadge.classList.remove('hidden');
            }
            if (typeof u.enabled === 'boolean') {
                enabledBadge.textContent = u.enabled ? 'Enabled' : 'Disabled';
                enabledBadge.classList.remove('hidden');
            }

            // Waiver (flexible keys)
            const waiverUrl = u.waiverUrl
            const signedAt   = u.waiverSignedAt || u.waiver?.signedAt;
            const notesVal   = u.internalNotes;

            if (waiverUrl) {
                waiverEmpty.classList.add('hidden');
                waiverLinkRow.classList.remove('hidden');
                waiverLink.href = waiverUrl;

                if (signedAt) {
                    waiverSignedRow.classList.remove('hidden');
                    waiverSignedAt.textContent = prettyDateTime(signedAt);
                }
                if (notesVal) {
                    waiverNotesRow.classList.remove('hidden');
                    waiverNotes.textContent = notesVal;
                }
            } else {
                // keep "No waiver on file."
                waiverLinkRow.classList.add('hidden');
                waiverSignedRow.classList.add('hidden');
                waiverNotesRow.classList.add('hidden');
            }

            setStatus(statusEl, 'success', 'User loaded.');
        } catch (e) {
            console.error(e);
            setStatus(statusEl, 'error', 'Failed to load user.');
        }
    });

    // Helpers
    function prettyDate(val) {
        if (!val) return '—';
        // Accepts 'YYYY-MM-DD' or ISO timestamps
        const d = new Date(val);
        if (isNaN(d.getTime())) {
            // Try YYYY-MM-DD manually
            if (/^\d{4}-\d{2}-\d{2}$/.test(String(val))) return String(val);
            return String(val);
        }
        return d.toLocaleDateString([], { year:'numeric', month:'short', day:'numeric' });
    }

    function prettyDateTime(val) {
        if (!val) return '—';
        const d = new Date(val);
        if (isNaN(d.getTime())) return String(val);
        return d.toLocaleString([], { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }
</script>
</body>
</html>